"0","# Create variable for deltas and first and second lag of the delta"
"0","dist_deltas <- dists %>% "
"0","  group_by(State, District) %>% "
"0","  mutate(delta_letters = std12_letters_and_up - lag(std12_letters_and_up, order_by = year), delta_nums = std12_numbers_and_up - lag(std12_numbers_and_up)) %>%"
"0","  mutate(delta_letters_lagged = lag(delta_letters, order_by = year), delta_letters_dbl_lag = lag(delta_letters, n= 2, order_by = year)) %>%"
"0","  arrange(State, District, year)"
"0",""
"0",""
"0","# Calculate autocorrelation of delta_letters by district and then average over all districts"
"0","# Note that since the data is already grouped by State and district, we are calculating "
"0","# autocorrelation for each district and then averaging across all districts"
"0","corr_dist_deltas <- dist_deltas %>% "
"0","  filter(year >= 2008) %>% "
"0","  summarise(auto = cor(delta_letters, delta_letters_lagged)) %>%"
"0","  ungroup() %>%"
"0","  summarise(mean_auto=mean(auto)) %>% .$mean_auto"
"0",""
"0",""
"0","# Calculate the autocorrelation in one go for all pairs of delta and delta_lagged."
"0","# Note that we are not doing any averaging here."
"0","# This should spit out a very similar value and it does."
"0","check_corr_dist_deltas <- dist_deltas %>% "
"0","  ungroup() %>%"
"0","  filter(year >= 2008) %>% "
"0","  summarise(auto = cor(delta_letters, delta_letters_lagged))"
"0",""
"0",""
"0","# Calculate the overall variance of the deltas"
"0","# Note that we have to divide by 100 here to get the actual number."
"0","# We didn't need to do this above because we just calculated correlation and thus scale didn't matter"
"0","var_dist_deltas <- var(dist_deltas$delta_letters/100, na.rm = TRUE)"
"0",""
"0","# Calculate overall variance of the district values."
"0","# Note that we don't want to first calculate variance of dist reading scores by state and then average"
"0","# That would really underestimate the variance of the district scores."
"0","# (To understand intuition, note districts are considered iid in the model above.)"
"0","var_dist_levels <- var(dists$std12_letters_and_up/100, na.rm = TRUE)"
"0",""
"0","# Calculate variance of the transitory component"
"0","var_dist_epsilon <- -corr_dist_deltas*var_dist_deltas"
"0",""
